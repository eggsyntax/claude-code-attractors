# GitHub Actions workflow for automated code quality monitoring
# Place this in .github/workflows/code-quality.yml

name: Code Quality Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-analysis:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        # Fetch full history for accurate baseline comparison
        fetch-depth: 0

    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Build Code Analyzer
      run: |
        cargo build --release --bin code-analyzer

    - name: Run Code Quality Analysis
      id: quality-check
      run: |
        ./target/release/code-analyzer analyze \
          --path . \
          --format json \
          --output quality-report.json \
          --ci-mode \
          --baseline-comparison \
          --regression-detection

    - name: Evaluate Quality Gates
      run: |
        ./target/release/code-analyzer ci-gates \
          --config .github/code-analyzer.yml \
          --report quality-report.json \
          --format github-status

    - name: Generate Quality Report
      run: |
        ./target/release/code-analyzer report \
          --input quality-report.json \
          --format html \
          --output quality-report.html

    - name: Upload Quality Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-report
        path: |
          quality-report.json
          quality-report.html
        retention-days: 30

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          try {
            const report = JSON.parse(fs.readFileSync('quality-report.json', 'utf8'));

            const status = report.overall_status;
            const emoji = status === 'Pass' ? '‚úÖ' : status === 'Warning' ? '‚ö†Ô∏è' : '‚ùå';

            const body = `## ${emoji} Code Quality Analysis

            **Overall Status:** ${status}
            **Commit:** ${report.commit_hash}
            **Branch:** ${report.branch}

            ### Quality Gates Results
            ${report.gate_results.map(gate => {
              const gateEmoji = gate.status === 'Pass' ? '‚úÖ' : gate.status === 'Warning' ? '‚ö†Ô∏è' : '‚ùå';
              return `${gateEmoji} **${gate.gate_name}**: ${gate.actual_value.toFixed(2)} (threshold: ${gate.threshold})`;
            }).join('\n')}

            ${report.regression_analysis ? `
            ### Regression Analysis
            - **Complexity Delta:** ${report.regression_analysis.complexity_delta > 0 ? '+' : ''}${report.regression_analysis.complexity_delta.toFixed(2)}
            - **New Issues:** ${report.regression_analysis.new_issues}
            - **Resolved Issues:** ${report.regression_analysis.resolved_issues}
            - **Risk Level:** ${report.regression_analysis.risk_assessment}
            ` : ''}

            ${report.recommendations.length > 0 ? `
            ### üí° Recommendations
            ${report.recommendations.map(rec => `- ${rec}`).join('\n')}
            ` : ''}

            ---
            *Generated by Code Quality Analyzer*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          } catch (error) {
            console.error('Failed to post quality report comment:', error);
          }

    - name: Update Status Check
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          try {
            const report = JSON.parse(fs.readFileSync('quality-report.json', 'utf8'));
            const state = report.overall_status === 'Pass' ? 'success' :
                         report.overall_status === 'Warning' ? 'success' : 'failure';

            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: state,
              target_url: `${context.payload.repository.html_url}/actions/runs/${context.runId}`,
              description: `Quality gates ${report.overall_status.toLowerCase()}`,
              context: 'Code Quality Analysis'
            });
          } catch (error) {
            console.error('Failed to update status check:', error);
          }

    - name: Fail on Quality Gate Violations
      if: always()
      run: |
        if [ -f quality-report.json ]; then
          status=$(jq -r '.overall_status' quality-report.json)
          if [ "$status" = "Fail" ]; then
            echo "‚ùå Quality gates failed - blocking merge"
            exit 1
          elif [ "$status" = "Warning" ]; then
            echo "‚ö†Ô∏è Quality gates passed with warnings"
            exit 0
          else
            echo "‚úÖ All quality gates passed"
            exit 0
          fi
        else
          echo "‚ùå Quality report not found"
          exit 1
        fi