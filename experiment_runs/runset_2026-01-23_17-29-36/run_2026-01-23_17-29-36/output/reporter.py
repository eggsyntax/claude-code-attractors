#!/usr/bin/env python3
"""
Collaborative Code Analysis Reporter
Generates human-readable reports from synthesis results.
"""

import json
from typing import Dict, List, Any

class CollaborativeReporter:
    """
    Generates comprehensive reports from collaborative analysis results.

    This class formats findings from both analyzers and synthesis results
    into various output formats (text, JSON, HTML).
    """

    def __init__(self):
        """Initialize the collaborative reporter."""
        pass

    def generate_text_report(self, synthesis_results: Dict[str, Any]) -> str:
        """
        Generate a comprehensive text report from synthesis results.

        Args:
            synthesis_results: Results from CollaborativeSynthesis

        Returns:
            Formatted text report as string
        """
        report = []
        report.append("ðŸ¤– COLLABORATIVE CODE ANALYSIS REPORT")
        report.append("=" * 50)

        # Summary statistics
        bob_count = len(synthesis_results.get('bob_findings', []))
        alice_count = len(synthesis_results.get('alice_findings', []))
        insights_count = len(synthesis_results.get('collaborative_insights', []))
        correlations_count = len(synthesis_results.get('correlated_findings', []))

        report.append(f"\nðŸ“Š ANALYSIS SUMMARY:")
        report.append(f"   Bob's Findings (Performance & Security): {bob_count}")
        report.append(f"   Alice's Findings (Design & Quality): {alice_count}")
        report.append(f"   Collaborative Insights: {insights_count}")
        report.append(f"   Correlated Issues: {correlations_count}")

        # Top collaborative insights
        if synthesis_results.get('collaborative_insights'):
            report.append(f"\nâœ¨ TOP COLLABORATIVE INSIGHTS:")
            report.append("-" * 30)
            for i, insight in enumerate(synthesis_results['collaborative_insights'][:5], 1):
                report.append(f"{i}. {insight['description']}")
                report.append(f"   Priority: {insight['priority']:.1f} | Category: {insight['category']}")
                if insight.get('recommendation'):
                    report.append(f"   ðŸ’¡ Recommendation: {insight['recommendation']}")
                report.append("")

        # Correlated findings
        if synthesis_results.get('correlated_findings'):
            report.append(f"\nðŸ”— CORRELATED ISSUES:")
            report.append("-" * 20)
            for correlation in synthesis_results['correlated_findings']:
                report.append(f"Lines {correlation['line_range']}: {correlation['description']}")
                report.append(f"   Impact Score: {correlation['impact_score']:.1f}")
                report.append("")

        # Individual findings summary
        report.append(f"\nðŸ” INDIVIDUAL FINDINGS SUMMARY:")
        report.append("-" * 30)

        if synthesis_results.get('bob_findings'):
            report.append("Bob's Key Findings:")
            for finding in synthesis_results['bob_findings'][:3]:
                report.append(f"  â€¢ {finding['description']} (confidence: {finding['confidence']:.1f})")

        if synthesis_results.get('alice_findings'):
            report.append("\nAlice's Key Findings:")
            for finding in synthesis_results['alice_findings'][:3]:
                report.append(f"  â€¢ {finding['description']} (confidence: {finding['confidence']:.1f})")

        # Collaboration metrics
        if synthesis_results.get('collaboration_metrics'):
            metrics = synthesis_results['collaboration_metrics']
            report.append(f"\nðŸ“ˆ COLLABORATION EFFECTIVENESS:")
            report.append(f"   Overlap Score: {metrics.get('overlap_score', 0):.2f}")
            report.append(f"   Correlation Score: {metrics.get('correlation_score', 0):.2f}")
            report.append(f"   Synthesis Effectiveness: {metrics.get('synthesis_effectiveness', 0):.2f}")

        report.append(f"\n" + "=" * 50)
        report.append("Generated by Alice & Bob's Collaborative Code Analyzer")

        return "\n".join(report)

    def generate_json_report(self, synthesis_results: Dict[str, Any]) -> str:
        """
        Generate a JSON report from synthesis results.

        Args:
            synthesis_results: Results from CollaborativeSynthesis

        Returns:
            JSON-formatted report as string
        """
        # Create a clean JSON structure
        json_report = {
            "analysis_type": "collaborative_code_analysis",
            "generated_by": "Alice & Bob AI Collaboration",
            "summary": {
                "bob_findings_count": len(synthesis_results.get('bob_findings', [])),
                "alice_findings_count": len(synthesis_results.get('alice_findings', [])),
                "collaborative_insights_count": len(synthesis_results.get('collaborative_insights', [])),
                "correlated_issues_count": len(synthesis_results.get('correlated_findings', []))
            },
            "collaborative_insights": synthesis_results.get('collaborative_insights', []),
            "correlated_findings": synthesis_results.get('correlated_findings', []),
            "individual_findings": {
                "bob": synthesis_results.get('bob_findings', []),
                "alice": synthesis_results.get('alice_findings', [])
            },
            "collaboration_metrics": synthesis_results.get('collaboration_metrics', {}),
            "recommendations": self._extract_recommendations(synthesis_results)
        }

        return json.dumps(json_report, indent=2, ensure_ascii=False)

    def generate_html_report(self, synthesis_results: Dict[str, Any]) -> str:
        """
        Generate an HTML report from synthesis results.

        Args:
            synthesis_results: Results from CollaborativeSynthesis

        Returns:
            HTML-formatted report as string
        """
        html_template = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Code Analysis Report</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 40px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white; padding: 20px; border-radius: 8px; }
        .section { margin: 20px 0; padding: 15px; border-left: 3px solid #667eea;
                   background: #f8f9fa; }
        .insight { background: white; padding: 15px; margin: 10px 0;
                   border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric { display: inline-block; margin: 10px; padding: 10px;
                  background: white; border-radius: 5px; }
        .finding { margin: 10px 0; padding: 10px; background: #e9ecef;
                   border-radius: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ¤– Collaborative Code Analysis Report</h1>
        <p>Generated by Alice & Bob AI Collaboration</p>
    </div>

    <div class="section">
        <h2>ðŸ“Š Analysis Summary</h2>
        <div class="metric">Bob's Findings: {bob_count}</div>
        <div class="metric">Alice's Findings: {alice_count}</div>
        <div class="metric">Collaborative Insights: {insights_count}</div>
        <div class="metric">Correlated Issues: {correlations_count}</div>
    </div>

    {insights_section}

    {correlations_section}

    {metrics_section}
</body>
</html>
        """

        # Build insights section
        insights_html = ""
        if synthesis_results.get('collaborative_insights'):
            insights_html = '<div class="section"><h2>âœ¨ Collaborative Insights</h2>'
            for insight in synthesis_results['collaborative_insights'][:5]:
                insights_html += f'''
                <div class="insight">
                    <h3>{insight['description']}</h3>
                    <p>Priority: {insight['priority']:.1f} | Category: {insight['category']}</p>
                    {f'<p><strong>Recommendation:</strong> {insight.get("recommendation", "")}</p>' if insight.get("recommendation") else ""}
                </div>
                '''
            insights_html += '</div>'

        # Build correlations section
        correlations_html = ""
        if synthesis_results.get('correlated_findings'):
            correlations_html = '<div class="section"><h2>ðŸ”— Correlated Issues</h2>'
            for correlation in synthesis_results['correlated_findings']:
                correlations_html += f'''
                <div class="finding">
                    <strong>Lines {correlation['line_range']}:</strong> {correlation['description']}
                    <br><small>Impact Score: {correlation['impact_score']:.1f}</small>
                </div>
                '''
            correlations_html += '</div>'

        # Build metrics section
        metrics_html = ""
        if synthesis_results.get('collaboration_metrics'):
            metrics = synthesis_results['collaboration_metrics']
            metrics_html = f'''
            <div class="section">
                <h2>ðŸ“ˆ Collaboration Effectiveness</h2>
                <div class="metric">Overlap Score: {metrics.get('overlap_score', 0):.2f}</div>
                <div class="metric">Correlation Score: {metrics.get('correlation_score', 0):.2f}</div>
                <div class="metric">Synthesis Effectiveness: {metrics.get('synthesis_effectiveness', 0):.2f}</div>
            </div>
            '''

        return html_template.format(
            bob_count=len(synthesis_results.get('bob_findings', [])),
            alice_count=len(synthesis_results.get('alice_findings', [])),
            insights_count=len(synthesis_results.get('collaborative_insights', [])),
            correlations_count=len(synthesis_results.get('correlated_findings', [])),
            insights_section=insights_html,
            correlations_section=correlations_html,
            metrics_section=metrics_html
        )

    def _extract_recommendations(self, synthesis_results: Dict[str, Any]) -> List[str]:
        """Extract all recommendations from synthesis results."""
        recommendations = []

        # From collaborative insights
        for insight in synthesis_results.get('collaborative_insights', []):
            if insight.get('recommendation'):
                recommendations.append(insight['recommendation'])

        # From individual findings
        for findings in [synthesis_results.get('bob_findings', []),
                        synthesis_results.get('alice_findings', [])]:
            for finding in findings:
                if finding.get('recommendation'):
                    recommendations.append(finding['recommendation'])

        return list(set(recommendations))  # Remove duplicates