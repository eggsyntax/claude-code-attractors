<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Code Analysis Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            color: white;
            text-align: center;
            margin-bottom: 30px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .panel h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .team-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
        }

        .project-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            transition: background-color 0.3s ease;
        }

        .project-item:hover {
            background-color: #f8f9fa;
        }

        .project-info h4 {
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .project-meta {
            font-size: 12px;
            color: #7f8c8d;
        }

        .project-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-left: 4px solid #3498db;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }

        .activity-content h5 {
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .activity-time {
            font-size: 12px;
            color: #7f8c8d;
        }

        .collaboration-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .team-member {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .complexity-trend {
            height: 200px;
        }

        .upload-area {
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #27ae60;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .team-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üë• Team Code Analysis Dashboard</h1>
        <p>Collaborative code quality monitoring and real-time insights</p>
        <div class="collaboration-status">
            <div class="status-indicator"></div>
            <span><strong>Live Collaboration Active</strong> - Connected team members can see updates in real-time</span>
        </div>
    </div>

    <div class="container">
        <!-- Team Overview Stats -->
        <div class="panel full-width">
            <h3>üìä Team Overview</h3>
            <div id="teamStats" class="team-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalProjects">0</div>
                    <div class="stat-label">Active Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalAnalyses">0</div>
                    <div class="stat-label">Total Analyses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgComplexity">0.0</div>
                    <div class="stat-label">Avg Complexity</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="qualityScore">A</div>
                    <div class="stat-label">Quality Grade</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeMembers">2</div>
                    <div class="stat-label">Team Members</div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Project Management -->
            <div class="panel">
                <h3>üìÇ Active Projects</h3>
                <div id="projectsList" class="project-list">
                    <!-- Projects will be loaded here -->
                </div>

                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 48px; margin-bottom: 10px;">üì§</div>
                    <h4>Upload New Project</h4>
                    <p>Drag & drop Python files or click to browse</p>
                    <input type="file" id="fileInput" multiple accept=".py" style="display: none;">
                </div>
            </div>

            <!-- Team Members -->
            <div class="panel">
                <h3>üë• Team Members</h3>
                <div class="team-member">
                    <div class="avatar">A</div>
                    <div>
                        <h5>Alice</h5>
                        <div class="activity-time">Online ‚Ä¢ Dashboard Expert</div>
                    </div>
                </div>
                <div class="team-member">
                    <div class="avatar">B</div>
                    <div>
                        <h5>Bob</h5>
                        <div class="activity-time">Online ‚Ä¢ Complexity Analysis Specialist</div>
                    </div>
                </div>
                <div class="team-member">
                    <div class="avatar">+</div>
                    <div>
                        <h5>Invite Team Member</h5>
                        <div class="activity-time">Send collaboration invite</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complexity Trend Analysis -->
        <div class="panel full-width">
            <h3>üìà Code Quality Trends</h3>
            <div id="complexityTrend" class="complexity-trend"></div>
        </div>

        <!-- Recent Activity -->
        <div class="panel full-width">
            <h3>üïê Recent Activity</h3>
            <div id="activityFeed" class="activity-feed">
                <!-- Activity items will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        // Sample data and WebSocket connection
        let websocket = null;
        let currentProject = 'team-dashboard';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            loadTeamData();
            loadRecentActivity();
            setupFileUpload();
            renderComplexityTrend();
        });

        function initializeWebSocket() {
            const wsUrl = `ws://localhost:8000/ws/${currentProject}`;
            websocket = new WebSocket(wsUrl);

            websocket.onopen = function() {
                console.log('Connected to collaboration server');
                showNotification('Connected to team collaboration!');
            };

            websocket.onmessage = function(event) {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };

            websocket.onclose = function() {
                console.log('Disconnected from collaboration server');
                // Attempt to reconnect
                setTimeout(initializeWebSocket, 5000);
            };

            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'analysis_complete':
                    showNotification(`New analysis completed for ${message.project_name}!`);
                    loadTeamData(); // Refresh data
                    addActivityItem({
                        type: 'analysis',
                        project: message.project_name,
                        user: 'Team Member',
                        timestamp: new Date()
                    });
                    break;

                case 'message':
                    // Handle team chat messages
                    console.log('Team message:', message.data);
                    break;
            }
        }

        function loadTeamData() {
            // Simulate loading team data
            const teamData = {
                totalProjects: 8,
                totalAnalyses: 47,
                avgComplexity: 6.2,
                qualityScore: 'B+',
                activeMembers: 2
            };

            document.getElementById('totalProjects').textContent = teamData.totalProjects;
            document.getElementById('totalAnalyses').textContent = teamData.totalAnalyses;
            document.getElementById('avgComplexity').textContent = teamData.avgComplexity.toFixed(1);
            document.getElementById('qualityScore').textContent = teamData.qualityScore;
            document.getElementById('activeMembers').textContent = teamData.activeMembers;

            loadProjectsList();
        }

        function loadProjectsList() {
            const projects = [
                {
                    name: 'Code Analysis System',
                    lastAnalysis: '2 minutes ago',
                    complexity: 'Medium',
                    status: 'Active',
                    analysisUrl: '/dashboards/analysis_dashboard.html'
                },
                {
                    name: 'Authentication Service',
                    lastAnalysis: '1 hour ago',
                    complexity: 'High',
                    status: 'Needs Review',
                    analysisUrl: '#'
                },
                {
                    name: 'Data Processing Pipeline',
                    lastAnalysis: '1 day ago',
                    complexity: 'Low',
                    status: 'Healthy',
                    analysisUrl: '#'
                },
                {
                    name: 'User Interface Components',
                    lastAnalysis: '2 days ago',
                    complexity: 'Medium',
                    status: 'Active',
                    analysisUrl: '#'
                }
            ];

            const projectsContainer = document.getElementById('projectsList');
            projectsContainer.innerHTML = '';

            projects.forEach(project => {
                const projectItem = document.createElement('div');
                projectItem.className = 'project-item';
                projectItem.innerHTML = `
                    <div class="project-info">
                        <h4>${project.name}</h4>
                        <div class="project-meta">
                            Last analysis: ${project.lastAnalysis} ‚Ä¢ Complexity: ${project.complexity}
                        </div>
                    </div>
                    <div class="project-actions">
                        <a href="${project.analysisUrl}" class="btn btn-primary">View Dashboard</a>
                        <button class="btn btn-secondary" onclick="reanalyzeProject('${project.name}')">Re-analyze</button>
                    </div>
                `;
                projectsContainer.appendChild(projectItem);
            });
        }

        function loadRecentActivity() {
            const activities = [
                {
                    type: 'analysis',
                    user: 'Alice',
                    action: 'completed analysis for Code Analysis System',
                    time: '2 minutes ago',
                    icon: 'üîç'
                },
                {
                    type: 'upload',
                    user: 'Bob',
                    action: 'uploaded new complexity analyzer module',
                    time: '15 minutes ago',
                    icon: 'üì§'
                },
                {
                    type: 'comment',
                    user: 'Alice',
                    action: 'added comment on Authentication Service complexity',
                    time: '1 hour ago',
                    icon: 'üí¨'
                },
                {
                    type: 'optimization',
                    user: 'Bob',
                    action: 'optimized Data Processing Pipeline',
                    time: '3 hours ago',
                    icon: '‚ö°'
                },
                {
                    type: 'analysis',
                    user: 'Alice',
                    action: 'completed scheduled analysis for all projects',
                    time: '1 day ago',
                    icon: 'üìä'
                }
            ];

            const activityContainer = document.getElementById('activityFeed');
            activityContainer.innerHTML = '';

            activities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <div class="activity-icon">${activity.icon}</div>
                    <div class="activity-content">
                        <h5>${activity.user} ${activity.action}</h5>
                        <div class="activity-time">${activity.time}</div>
                    </div>
                `;
                activityContainer.appendChild(activityItem);
            });
        }

        function addActivityItem(activity) {
            const activityContainer = document.getElementById('activityFeed');
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';

            const icons = {
                analysis: 'üîç',
                upload: 'üì§',
                comment: 'üí¨',
                optimization: '‚ö°'
            };

            activityItem.innerHTML = `
                <div class="activity-icon">${icons[activity.type] || 'üìä'}</div>
                <div class="activity-content">
                    <h5>${activity.user} completed analysis for ${activity.project}</h5>
                    <div class="activity-time">Just now</div>
                </div>
            `;

            activityContainer.insertBefore(activityItem, activityContainer.firstChild);
        }

        function renderComplexityTrend() {
            // Sample trend data
            const dates = [];
            const complexityScores = [];
            const qualityScores = [];

            for (let i = 30; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);

                // Simulate improving trend
                complexityScores.push(8 - (i * 0.05) + Math.random() * 0.5);
                qualityScores.push(7 + (i * 0.03) + Math.random() * 0.3);
            }

            const trace1 = {
                x: dates,
                y: complexityScores,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Average Complexity',
                line: { color: '#e74c3c', width: 3 },
                marker: { size: 6 }
            };

            const trace2 = {
                x: dates,
                y: qualityScores,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Code Quality Score',
                line: { color: '#27ae60', width: 3 },
                marker: { size: 6 },
                yaxis: 'y2'
            };

            const layout = {
                title: 'Code Quality Trends Over Time',
                xaxis: { title: 'Date' },
                yaxis: {
                    title: 'Complexity Score',
                    side: 'left',
                    color: '#e74c3c'
                },
                yaxis2: {
                    title: 'Quality Score',
                    side: 'right',
                    overlaying: 'y',
                    color: '#27ae60'
                },
                legend: { x: 0, y: 1 },
                margin: { t: 40, r: 60, b: 40, l: 60 }
            };

            Plotly.newPlot('complexityTrend', [trace1, trace2], layout, { responsive: true });
        }

        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');

            fileInput.addEventListener('change', function(event) {
                const files = Array.from(event.target.files);
                if (files.length > 0) {
                    uploadFiles(files);
                }
            });

            // Add drag and drop functionality
            const uploadArea = document.querySelector('.upload-area');

            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#3498db';
                uploadArea.style.backgroundColor = '#f8f9fa';
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#bdc3c7';
                uploadArea.style.backgroundColor = 'transparent';
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#bdc3c7';
                uploadArea.style.backgroundColor = 'transparent';

                const files = Array.from(e.dataTransfer.files).filter(file =>
                    file.name.endsWith('.py')
                );

                if (files.length > 0) {
                    uploadFiles(files);
                }
            });
        }

        function uploadFiles(files) {
            showNotification(`Uploading ${files.length} files...`);

            const formData = new FormData();
            files.forEach(file => formData.append('files', file));
            formData.append('project_name', 'team-upload-' + Date.now());

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showNotification('Upload and analysis complete!');
                loadTeamData(); // Refresh projects list

                // Add to activity feed
                addActivityItem({
                    type: 'upload',
                    user: 'You',
                    project: data.analysis_id || 'New Project',
                    timestamp: new Date()
                });
            })
            .catch(error => {
                console.error('Upload error:', error);
                showNotification('Upload failed. Please try again.', 'error');
            });
        }

        function reanalyzeProject(projectName) {
            showNotification(`Re-analyzing ${projectName}...`);
            // Implementation would call the analysis API
            setTimeout(() => {
                showNotification(`Analysis of ${projectName} complete!`);
                loadTeamData();
            }, 2000);
        }

        function showNotification(text, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');

            notificationText.textContent = text;
            notification.style.background = type === 'error' ? '#e74c3c' : '#27ae60';
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Send team messages via WebSocket
        function sendTeamMessage(message) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'team_message',
                    message: message,
                    user: 'Current User',
                    timestamp: new Date().toISOString()
                }));
            }
        }
    </script>
</body>
</html>